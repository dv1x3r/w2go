<!DOCTYPE html>
<html lang="en">

<head>
  <title>w2go example</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" type="text/css" href="/lib/w2ui.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="main" style="width: 100vw; height: 100vh; min-width: 800px">Loading...</div>
  <script type="module">
    import {w2form, w2grid, w2popup} from '/lib/w2ui.es6.min.js'
    import {w2init, w2fetch, remoteListOptions, reloadOnSuccess, doubleClickNonEditable} from '/lib/w2ui.helpers.js'

    // set window.w2ui and window.w2tooltip
    // set w2utils.settings.dataType = 'JSON'
    // register extra formatters like 'text' and 'dropdown'
    w2init()

    new w2grid({
      name: 'todoGrid',
      box: '#main',
      url: {
        get: '/api/v1/todo/grid/records',
        save: '/api/v1/todo/grid/save',
        remove: '/api/v1/todo/grid/remove',
      },
      recid: 'id',
      multiSearch: true,
      show: {
        footer: true,
        toolbar: true,
        toolbarAdd: true,
        toolbarEdit: true,
        toolbarDelete: true,
        toolbarSave: true,
        toolbarSearch: true,
        toolbarReload: true,
        searchSave: false,
      },
      columns: [
        {
          field: 'id',
          text: 'ID',
          size: '60px',
          sortable: true,
          searchable: 'int',
        },
        {
          field: 'name',
          text: 'Name',
          render: 'text',
          size: '250px',
          sortable: true,
          searchable: 'text',
        },
        {
          field: 'description',
          text: 'Description',
          render: 'text',
          size: '400px',
          sortable: true,
          searchable: 'text',
          editable: {type: 'text'},
        },
        {
          field: 'status',
          text: 'Status',
          render: 'dropdown',
          size: '88px',
          sortable: true,
          searchable: {type: 'enum', options: remoteListOptions('/api/v1/status/dropdown')},
          editable: remoteListOptions('/api/v1/status/dropdown'),
        },
        {
          field: 'quantity',
          text: 'Quantity',
          render: 'int',
          size: '88px',
          sortable: true,
          searchable: 'int',
          editable: {type: 'int'},
        },
      ],
      defaultOperator: {
        'text': 'contains',
      },
      sortData: [
        {field: 'id', direction: 'asc'},
      ],
      toolbar: {
        items: [
          {type: 'break'},
          {
            id: 'status',
            type: 'button',
            text: 'Status Enum',
            icon: 'w2ui-icon-settings',
            onClick: () => openStatusPopup(),
          },
        ],
      },
      onAdd: function (event) {openTodoPopup(event)},
      onEdit: function (event) {openTodoPopup(event)},
      onSave: function (event) {reloadOnSuccess(event)},
      onDblClick: function (event) {doubleClickNonEditable(event, openTodoPopup)},
    })

    function openTodoPopup(event) {
      const todoForm = new w2form({
        name: `todoForm`,
        url: '/api/v1/todo/form',
        recid: event.detail.recid,
        fields: [
          {
            field: 'id',
            type: 'text',
            hidden: event.type == 'add',
            html: {
              label: 'ID',
              attr: 'size="10" readonly',
              span: 4,
            },
          },
          {
            field: 'name',
            type: 'text',
            required: true,
            html: {
              label: 'Name',
              attr: 'style="width:100%; min-width:100px;',
              span: 4,
            },
          },
          {
            field: 'description',
            type: 'text',
            required: true,
            html: {
              label: 'Description',
              attr: 'style="width:100%; min-width:100px;',
              span: 4,
            },
          },
          {
            field: 'status',
            type: 'list',
            required: true,
            options: remoteListOptions('/api/v1/status/dropdown'),
            html: {
              label: 'Status',
              attr: 'style="width:100%; min-width:100px;',
              span: 4,
            },
          },
          {
            field: 'quantity',
            type: 'int',
            required: true,
            html: {
              label: 'Quantity',
              attr: 'style="width:100%; min-width:100px;',
              span: 4,
            },
          },
        ],
        actions: {
          async Save() {
            const res = await this.save()
            if (res.status == 'success') {
              event.owner.reload()
              w2popup.close()
            }
          },
          Cancel() {w2popup.close()},
        },
      })

      w2popup.open({
        title: event.type == 'add' ? 'New Todo' : 'Edit Todo',
        body: '<div id="todo-form" style="width: 100%; height: 100%;"></div>',
        width: 500, height: 350, showMax: true, resizable: true,
      })
        .then(() => todoForm.render('#todo-form'))
        .close(() => todoForm.destroy())
    }

    function openStatusPopup() {
      const statusGrid = new w2grid({
        name: 'statusGrid',
        url: '/api/v1/status/grid/records',
        recid: 'id',
        reorderRows: true,
        show: {
          footer: true,
          toolbar: false,
        },
        columns: [
          {
            field: 'id',
            text: 'ID',
            size: '60px',
          },
          {
            field: 'name',
            text: 'Name',
            render: 'text',
            size: '250px',
          },
        ],
        onReorderRow: async function (event) {
          await w2fetch({
            owner: this,
            lock: 'Reordering...',
            url: '/api/v1/status/grid/reorder',
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(event.detail),
          })
        },
      })

      w2popup.open({
        title: 'Status Enum',
        body: '<div id="status-grid" style="width: 100%; height: 100%;"></div>',
        width: 500, height: 350, showMax: true, resizable: true,
      })
        .then(() => statusGrid.render('#status-grid'))
        .close(() => statusGrid.destroy())
    }
  </script>
</body>

</html>